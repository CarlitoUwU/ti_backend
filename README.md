# üå± Light for Life - Energy Management API

<p align="center">
  <img src="https://nestjs.com/img/logo-small.svg" width="120" alt="NestJS Logo" />
</p>

<p align="center">
  <strong>Sistema de Gesti√≥n Energ√©tica Inteligente</strong><br>
  API RESTful desarrollada con NestJS para promover el ahorro energ√©tico y la conciencia ambiental
</p>

<p align="center">
  <a href="https://www.npmjs.com/~nestjscore" target="_blank">
    <img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" />
  </a>
  <a href="https://www.npmjs.com/~nestjscore" target="_blank">
    <img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" />
  </a>
  <img src="https://img.shields.io/badge/Node.js-18+-green.svg" alt="Node Version" />
  <img src="https://img.shields.io/badge/TypeScript-5.0+-blue.svg" alt="TypeScript" />
</p>

---

## üìã Tabla de Contenidos

- [üéØ Descripci√≥n](#-descripci√≥n)
- [‚ú® Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [üèóÔ∏è Arquitectura](#Ô∏è-arquitectura)
- [üöÄ Instalaci√≥n](#-instalaci√≥n)
- [‚öôÔ∏è Configuraci√≥n](#Ô∏è-configuraci√≥n)
- [üîß Uso](#-uso)
- [üìä API Endpoints](#-api-endpoints)
- [üîî Sistema de Notificaciones](#-sistema-de-notificaciones)
- [üèÉ‚Äç‚ôÇÔ∏è Ejecutar el Proyecto](#Ô∏è-ejecutar-el-proyecto)
- [üß™ Testing](#-testing)
- [üì¶ Deployment](#-deployment)
- [ü§ù Contribuir](#-contribuir)
- [üìÑ Licencia](#-licencia)

---

## üéØ Descripci√≥n

**Light for Life** es una API robusta y escalable dise√±ada para ayudar a los usuarios a gestionar y optimizar su consumo energ√©tico diario. El sistema incentiva el ahorro de energ√≠a a trav√©s de un sistema inteligente de notificaciones autom√°ticas, seguimiento de metas y gamificaci√≥n.

### üåü Misi√≥n
Promover la conciencia ambiental y el ahorro energ√©tico mediante tecnolog√≠a innovadora que motiva a los usuarios a adoptar h√°bitos m√°s sostenibles.

---

## ‚ú® Caracter√≠sticas Principales

### üìä **Gesti√≥n de Consumo**
- ‚úÖ Registro diario de consumo energ√©tico por dispositivo
- ‚úÖ C√°lculo autom√°tico de consumo estimado (kWh)
- ‚úÖ Seguimiento mensual de gastos energ√©ticos
- ‚úÖ Hist√≥rico completo de consumos

### üéØ **Sistema de Metas**
- ‚úÖ Establecimiento de metas mensuales de consumo
- ‚úÖ C√°lculo autom√°tico de ahorros en tiempo real
- ‚úÖ Comparaci√≥n contra objetivos establecidos
- ‚úÖ Alertas de proximidad al l√≠mite de meta

### üîî **Notificaciones Inteligentes**
- ‚úÖ **Al Login**: Verificaciones cr√≠ticas autom√°ticas
- ‚úÖ **Tiempo Real**: Alertas de l√≠mites y metas superadas
- ‚úÖ **Programadas**: Recordatorios diarios y semanales
- ‚úÖ **Motivacionales**: Celebraci√≥n de logros y progreso positivo

### üèÜ **Gamificaci√≥n**
- ‚úÖ Sistema de medallas por logros
- ‚úÖ Videos educativos sobre ahorro energ√©tico
- ‚úÖ Seguimiento de rachas de ahorro
- ‚úÖ Perfiles de usuario personalizados

### üîê **Seguridad y Autenticaci√≥n**
- ‚úÖ Autenticaci√≥n segura con bcrypt
- ‚úÖ Recuperaci√≥n de contrase√±a por email
- ‚úÖ C√≥digos de verificaci√≥n temporales
- ‚úÖ Validaci√≥n de datos con class-validator

---

## üèóÔ∏è Arquitectura

### **Stack Tecnol√≥gico**
- **Framework**: NestJS con TypeScript
- **Base de Datos**: PostgreSQL con Prisma ORM
- **Cache**: Redis para sesiones y datos temporales
- **Email**: Nodemailer con templates Handlebars
- **Documentaci√≥n**: Swagger/OpenAPI
- **Programaci√≥n de Tareas**: @nestjs/schedule con cron jobs
- **Validaci√≥n**: class-validator y class-transformer

### **Estructura Modular**
```
src/
‚îú‚îÄ‚îÄ app/                    # M√≥dulo principal de la aplicaci√≥n
‚îú‚îÄ‚îÄ common/                 # Servicios compartidos
‚îÇ   ‚îú‚îÄ‚îÄ config/            # Configuraci√≥n de entorno
‚îÇ   ‚îú‚îÄ‚îÄ redis/             # Configuraci√≥n de Redis
‚îÇ   ‚îî‚îÄ‚îÄ services/          # Servicios comunes (fecha, tareas)
‚îî‚îÄ‚îÄ modules/               # M√≥dulos de funcionalidad
    ‚îú‚îÄ‚îÄ users/             # Gesti√≥n de usuarios
    ‚îú‚îÄ‚îÄ districts/         # Distritos y tarifas el√©ctricas
    ‚îú‚îÄ‚îÄ devices/           # Dispositivos el√©ctricos
    ‚îú‚îÄ‚îÄ daily-consumptions/ # Consumos diarios
    ‚îú‚îÄ‚îÄ monthly-consumptions/ # Res√∫menes mensuales
    ‚îú‚îÄ‚îÄ goals/             # Metas de ahorro
    ‚îú‚îÄ‚îÄ savings/           # C√°lculo de ahorros
    ‚îú‚îÄ‚îÄ notifications/     # Sistema de notificaciones
    ‚îú‚îÄ‚îÄ videos/            # Contenido educativo
    ‚îú‚îÄ‚îÄ medals/            # Sistema de logros
    ‚îú‚îÄ‚îÄ users-videos/      # Relaci√≥n usuarios-videos
    ‚îú‚îÄ‚îÄ users-medals/      # Relaci√≥n usuarios-medallas
    ‚îú‚îÄ‚îÄ mails/             # Servicios de email
    ‚îî‚îÄ‚îÄ chatbot/           # Asistente virtual
```

---

## üöÄ Instalaci√≥n

### **Prerrequisitos**
- Node.js 18+ 
- PostgreSQL 12+
- Redis 6+
- npm o yarn

### **Clonar el Repositorio**
```bash
git clone https://github.com/CarlitoUwU/ti_backend
cd ti_backend
```

### **Instalar Dependencias**
```bash
npm install
```

---

## ‚öôÔ∏è Configuraci√≥n

### **1. Variables de Entorno**
Copia el archivo `.env.example` a `.env` y configura las variables:

```bash
cp .env.example .env
```

```env
# Database Configuration
DATABASE_URL="postgresql://username:password@localhost:5432/database_name"

# Security
BCRYPT_SALT=10

# Timezone (DO NOT CHANGE - Required for Peru timezone)
TZ=America/Lima

# Email Configuration
MAIL_HOST=smtp.gmail.com
MAIL_USER=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_FROM=noreply@your-domain.com

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
```

### **2. Base de Datos**
```bash
# Generar el cliente de Prisma
npx prisma generate

# Ejecutar migraciones
npx prisma db push

# (Opcional) Sembrar datos iniciales
npx prisma db seed
```

### **3. Redis**
Aseg√∫rate de que Redis est√© corriendo:
```bash
redis-server
```

---

## üîß Uso

### **Desarrollo**
```bash
# Modo desarrollo con hot-reload
npm run start:dev

# Modo debug
npm run start:debug
```

### **Producci√≥n**
```bash
# Compilar el proyecto
npm run build

# Ejecutar en producci√≥n
npm run start:prod
```

### **URLs Importantes**
- **API**: http://localhost:3000
- **Documentaci√≥n Swagger**: http://localhost:3000/swagger
- **Health Check**: http://localhost:3000/api

---

## üìä API Endpoints

### **üîê Autenticaci√≥n**
```http
POST /api/users/login                    # Iniciar sesi√≥n
POST /api/users                         # Registrar usuario
POST /api/users/create-reset-password    # Solicitar recuperaci√≥n
POST /api/users/verify-reset-code        # Verificar c√≥digo
POST /api/users/reset-password           # Restablecer contrase√±a
```

### **üë§ Usuarios**
```http
GET    /api/users                 # Listar usuarios
GET    /api/users/:id             # Obtener usuario espec√≠fico
PATCH  /api/users/:id/activate    # Activar usuario
PATCH  /api/users/:id/deactivate  # Desactivar usuario
DELETE /api/users/:id             # Eliminar usuario
```

### **üìä Consumos Diarios**
```http
POST   /api/daily-consumptions                           # Registrar consumo
GET    /api/daily-consumptions                           # Listar consumos
GET    /api/daily-consumptions/user/:userId              # Consumos por usuario
GET    /api/daily-consumptions/user/:userId/date         # Consumos por fecha
PUT    /api/daily-consumptions/:id                       # Actualizar consumo
PATCH  /api/daily-consumptions/:id/activate              # Activar registro
PATCH  /api/daily-consumptions/:id/deactivate            # Desactivar registro
DELETE /api/daily-consumptions/:id                       # Eliminar consumo
```

### **üéØ Metas**
```http
POST   /api/goals                        # Crear meta mensual
GET    /api/goals                        # Listar metas
GET    /api/goals/user/:userId           # Metas por usuario
GET    /api/goals/user/:userId/period    # Metas por per√≠odo
PUT    /api/goals/:id                    # Actualizar meta
PATCH  /api/goals/:id/activate           # Activar meta
PATCH  /api/goals/:id/deactivate         # Desactivar meta
DELETE /api/goals/:id                    # Eliminar meta
```

### **üí∞ Ahorros**
```http
GET    /api/savings                      # Listar ahorros
GET    /api/savings/user/:userId         # Ahorros por usuario
GET    /api/savings/user/:userId/period  # Ahorros por per√≠odo
PATCH  /api/savings/:id                  # Recalcular ahorros
```

### **üì± Dispositivos**
```http
POST   /api/devices              # Crear dispositivo
GET    /api/devices              # Listar dispositivos
GET    /api/devices/:id          # Obtener dispositivo
PATCH  /api/devices/:id/activate # Activar dispositivo
DELETE /api/devices/:id          # Eliminar dispositivo
```

### **üèõÔ∏è Distritos**
```http
POST   /api/districts            # Crear distrito
GET    /api/districts            # Listar distritos
GET    /api/districts/:id        # Obtener distrito
DELETE /api/districts/:id        # Eliminar distrito
```

---

## üîî Sistema de Notificaciones

### **Tipos de Notificaciones**

#### **üîë Al Login**
```http
POST /api/notifications/check-login/:userId
```
- Meta mensual faltante
- Consumo diario pendiente (despu√©s de las 18:00)
- Meta superada (cr√≠tico)

#### **‚ö° Tiempo Real** (Autom√°ticas)
- Cerca del l√≠mite de meta (80%)
- Meta superada
- Se ejecutan al registrar consumo diario

#### **üïê Programadas (Cron Jobs)**

**Diario (18:00 Per√∫)**
```http
POST /api/notifications/check-daily-all
```
- Recordatorio de consumo diario faltante

**Semanal (Domingos 10:00 Per√∫)**
```http
POST /api/notifications/check-weekly-all
```
- Verificaci√≥n de progreso hacia la meta
- Notificaci√≥n de progreso positivo (ahorro > 15%)

**Mensual**
```http
POST /api/notifications/check-month-start-all  # D√≠a 1, 09:00
POST /api/notifications/check-month-end-all    # √öltimo d√≠a, 20:00
```
- Inicio: Recordatorio para establecer meta
- Fin: Resumen mensual de ahorro/gasto

### **Ejemplos de Mensajes**
- üì± *"¬°No olvides registrar tu consumo energ√©tico de hoy!"*
- ‚ö†Ô∏è *"¬°Atenci√≥n! Has usado 85% de tu meta mensual. Te quedan 12.5 kWh disponibles."*
- üéâ *"¬°Felicitaciones! Est√°s ahorrando 15.2 kWh este mes (20% de eficiencia)."*
- üìä *"Resumen de Junio 2025: ¬°Ahorraste 25.8 kWh y S/ 18.50! üéâ"*

### **Configuraci√≥n de Cron Jobs**
Los cron jobs est√°n configurados autom√°ticamente en `TasksService` con zona horaria de Per√∫ (America/Lima):

```typescript
// Diario 18:00
@Cron('0 18 * * *', { timeZone: 'America/Lima' })

// Semanal Domingos 10:00  
@Cron('0 10 * * 0', { timeZone: 'America/Lima' })

// Mensual d√≠a 1, 09:00
@Cron('0 9 1 * *', { timeZone: 'America/Lima' })
```

---

## üèÉ‚Äç‚ôÇÔ∏è Ejecutar el Proyecto

### **Comando R√°pido**
```bash
# Instalar dependencias y ejecutar
npm install && npm run start:dev
```

### **Con Docker (Opcional)**
```bash
# Construir imagen
docker build -t light-for-life-api .

# Ejecutar contenedor
docker run -p 3000:3000 light-for-life-api
```

### **URLs de Verificaci√≥n**
- ‚úÖ **API**: http://localhost:3000/api
- ‚úÖ **Swagger Docs**: http://localhost:3000/swagger
- ‚úÖ **Health Check**: Verificar que muestre el mensaje de bienvenida

---

## üß™ Testing

```bash
# Tests unitarios
npm run test

# Tests e2e
npm run test:e2e

# Cobertura de tests
npm run test:cov

# Linting
npm run lint
```

---

## üì¶ Deployment

### **Variables de Entorno de Producci√≥n**
```env
NODE_ENV=production
DATABASE_URL=postgresql://prod_user:prod_pass@prod_host:5432/prod_db
REDIS_HOST=prod_redis_host
MAIL_HOST=production_smtp_host
```

### **Plataformas Recomendadas**
- **Backend**: Railway, Render, DigitalOcean
- **Base de Datos**: Railway PostgreSQL, AWS RDS
- **Redis**: Railway Redis, AWS ElastiCache
- **DNS/CDN**: Cloudflare

### **Comandos de Deployment**
```bash
# Compilar para producci√≥n
npm run build

# Ejecutar migraciones
npx prisma migrate deploy

# Iniciar en producci√≥n
npm run start:prod
```

---

## ü§ù Contribuir

### **Estructura de Commits**
```
feat: nueva funcionalidad
fix: correcci√≥n de bug
docs: documentaci√≥n
style: formato de c√≥digo
refactor: refactorizaci√≥n
test: a√±adir tests
chore: tareas de mantenimiento
```

### **Pull Requests**
1. Fork el proyecto
2. Crear rama feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit cambios (`git commit -m 'feat: a√±adir nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Abrir Pull Request

---

## üìû Soporte

### **Equipo de Desarrollo**
- **Email**: LightForLifeX@gmail.com
- **Documentaci√≥n**: http://localhost:3000/swagger (en desarrollo)

### **Reportar Issues**
Para reportar bugs o solicitar nuevas funcionalidades, por favor crear un issue en el repositorio con:
- Descripci√≥n detallada del problema
- Pasos para reproducir
- Screenshots (si aplica)
- Informaci√≥n del entorno

---

## üìÑ Licencia

Este proyecto est√° bajo la licencia **UNLICENSED** - ver el archivo [LICENSE](LICENSE) para m√°s detalles.

---

## üåü Agradecimientos

- **NestJS** por el framework robusto y escalable
- **Prisma** por el excelente ORM
- **Comunidad TypeScript** por las herramientas y librer√≠as

---

<p align="center">
  <strong>Desarrollado con ‚ù§Ô∏è por el equipo de Light for Life</strong><br>
  <em>Promoviendo un futuro m√°s sostenible a trav√©s de la tecnolog√≠a</em>
</p>

---

**üå± Juntos hacia un futuro m√°s verde y eficiente energ√©ticamente üå±**
